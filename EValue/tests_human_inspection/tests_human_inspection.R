
library(testthat)
#library(EValue)
library(devtools)
library(dplyr)
library(ICC)

# for simulating meta-analysis data
library(here())
setwd(here())
setwd("tests")
source("testthat_helper.R")


##### Simulate Data with Random Parameters #####

# data-generation parameters
k = round( runif(1, 11, 40) )
mu = rnorm(1, mean = 0, sd = 2)  # log-RR
V = 0
if (rbinom(n=1, size=1, prob=0.5)) V = runif(1, 0, 2)
dist = sample(c("normal", "expo"), 1)

# confounded_meta parameters
method = sample(c("calibrated", "parametric"), 1)
q = runif(1, 0, 1)
# sometimes choose q equal to mean
if (rbinom(n=1, size=1, prob=0.5)) q = mu


r = runif(1, 0, 1)
muB = rnorm(1, mean = 0, sd = 2)

sigB = 0
if (rbinom(n=1, size=1, prob=0.5)) sigB = runif(1, 0, 1)
if ( sigB^2 > V ) sigB = sqrt(V)

tail = sample(c("above", "below"), 1)
give.CI = sample(c(TRUE, FALSE), 1)

if ( tail == "above" ) yr.corr = mu - muB
if ( tail == "below" ) yr.corr = mu + muB
theoryP = calculate_theory_p( true.effect.dist = dist, 
                              q = q,
                              b0 = yr.corr,
                              bc = 0,
                              bb = 0,
                              zc = 0,   
                              zb = 0,
                              V = V - sigB^2 )
if ( tail == "below" ) theoryP = 1 - theoryP



d = sim_data2( k = k,
               m = k,
               b0 = mu, # intercept
               bc = 0, # effect of continuous moderator
               bb = 0, # effect of binary moderator
               V = V, 
               Vzeta = 0, # used to calcuate within-cluster variance
               
               muN = 100,
               minN = 50,
               sd.w = 1,
               true.effect.dist = dist )

# fit meta-analysis
meta = rma.uni(yi = d$yi,
               sei = sqrt(d$vyi),
               method = "REML")


( x = confounded_meta(method=method,
                    q=q,
                    r = r,
                    tail = tail,
                    muB=muB,
                    
                    yr = meta$b,
                    vyr = meta$se^2,
                    t2 = meta$tau2,
                    vt2 = meta$se.tau2^2,
                    
                    give.CI=give.CI,
                    dat = d,
                    yi.name = "yi",
                    vi.name = "vyi") )
x$Est[ x$Value == "Prop" ]; theoryP  # should be reasonably close
exp(yr.corr)
exp(q)
tail
# just changed confounded_meta to use Phat_CI_lims instead of its own boot loop



sens_plot( method = method,
           type="line",
           q=q,
           tail = tail,
           # Bmin=log(1),
           # Bmax=log(4),
           dat = d,
           yi.name = "yi",
           vi.name = "vyi",
           give.CI = TRUE )


###### sens_plot warnings #####


# # MOVE THIS - CURRENTLY NEEDS VISUAL INSPECTION
# # Justin's example
# # AWR data
# d= data.frame(yi=c(-0.3883008, 0.001426734, -0.08581416, 0.395127, 0.1092, 0.07114, 
#                    0.17653, 0.136117003337663, 0.342124561406763, 0.252086059233745, 
#                    0.314665445289022, 0.421759710393802, 0.72, 0.5041, 0.304111858143918, 
#                    0.247354285385813, 0.10058506599129, -0.118305012628413, 0.00614003662934362, 
#                    -0.0304231996789343, 0.0534217444839396, 0.081429018693521, 0.00844345205610478, 
#                    -0.0956313232211962, -0.0836335206629792, -0.0107, 0.785122741396379, 
#                    0.538183229496483, 0.458354887904454, 0.294567011794039, 0.218197091864461, 
#                    0.652125970874945, 0.747264717757073, -0.107004832606107, 0.451854718622882, 
#                    1.57307026826323, 1.02370769181225, -0.0607597825627846, -0.24725298647526, 
#                    -0.138498171440489, 0.3735, 0.3167, 0.3866, 0.1361, 0.3909, 0.1714, 
#                    -0.3542, 0.077449, 0.060872, -0.05842669, -0.108307, 0.314493329902438, 
#                    0.580160317167055, 0.354545017680907, 0.3003748992502, 0.0599, 
#                    0.16431, 0.169091341245452, 0.533180306149236, 0.2319, 0.1133, 
#                    0.202, 0.42744401482694, 0.226773319364788, 0.527527473383922, 
#                    0.336472236621213, 1.02295272582297, -0.0395789862806581, 0.20430046351273, 
#                    0.0674412807955327, 0.20430046351273, 0.737598943130779, 0.358451143339988, 
#                    0.737598943130779, 0.632238427472953, 0.71512608727872, 0.249762837589487, 
#                    -0.225246601510989, -0.393630650461162, 0.403203590617197, 0.0614542968951408, 
#                    0.618951439970278, 0.401227956125408, 0.166814812552967, 0.469239166741951, 
#                    0.222436494614775, 0.0251690408975854, 0.254530482413312, 0.484064617239069, 
#                    0.0825347072563428, 0.309429213914223, 0.13597, 0.229988950871245, 
#                    0.180286051306973, -0.356674943938732, -0.22314355131421, 0.289732692553181, 
#                    0.171146432957757, -0.0599280772038794, -0.0156637000983808),
#               vi=c(0.1138651, 0.008177298, 0.01900103, 0.05670225, 0.006, 0.001103623, 
#                    0.006292858, 0.0195950658754145, 0.0205094531162407, 0.018752838259364, 
#                    0.0190121846906155, 0.0576914766153845, 0.0679, 0.0844, 0.0114905535848697, 
#                    0.0118027901968592, 0.0129322943386893, 0.0296758296762902, 0.0179986076866442, 
#                    0.0186617590063628, 0.0215076549874847, 0.0178329156067095, 0.0242149451631579, 
#                    0.0271859268131303, 0.0190496382204289, 0.0026, 0.0294288030340315, 
#                    0.0804702430939741, 0.0794666643979177, 0.0816697065736585, 0.0815705207907224, 
#                    0.0148002283675237, 0.0163383675928479, 0.0405538766014622, 0.00394466942312636, 
#                    2.20515873015873, 0.00456944344847663, 0.0242380941338984, 0.0188261198732234, 
#                    0.0185790983464913, 0.017, 0.029, 0.0148, 0.0184, 0.0155, 0.0189, 
#                    0.0817, 0.002377879, 0.002475808, 0.02098244, 0.01944182, 0.00417912736753316, 
#                    0.00523453155032102, 0.00423414840690166, 0.00434010652988755, 
#                    0.00615334, 0.0060461344, 0.0709704089573533, 0.0743330971418842, 
#                    0.023, 0.0259, 0.0123, 0.297308488612836, 0.274220465524813, 
#                    0.294802222948676, 0.299378881987578, 0.231928132534806, 0.306192639288032, 
#                    0.322705314009662, 0.355005055611729, 0.322705314009662, 0.255533596837945, 
#                    0.298895790200138, 0.255533596837945, 0.266644707949056, 0.256038647342995, 
#                    0.321671722278396, 0.0738578472324602, 0.0805166511048864, 0.0273178948938246, 
#                    0.0380391424571774, 0.0226192846354108, 0.0279071812276552, 0.0343354387534737, 
#                    0.0259296591511232, 0.0598412948100846, 0.0520311405375446, 0.0610968618672542, 
#                    0.0623812011641122, 0.0606576664992567, 0.0613314124122998, 0.007144952, 
#                    0.0310383566014782, 0.0303357312563175, 0.151948051948052, 0.134090909090909, 
#                    0.0292896559171526, 0.0329069307439105, 0.0370536637705433, 0.0266674845050026
#               ))
# 
# # low R triggers warning about CIs never being estimable
# sens_plot(method="calibrated",
#           type="line",
#           q=0.2,
#           #r=NA,
#           CI.level=0.95,
#           tail="above",
#           give.CI=TRUE,
#           Bmin=log(1),
#           Bmax=log(5),
#           # for type "line" and method "calibrated"
#           R=50,
#           dat = d,
#           yi.name = "yi",
#           vi.name = "vi")
# 
# # higher R triggers warning about some CIs not being estimable
# sens_plot(method="calibrated",
#           type="line",
#           q=0.2,
#           #r=NA,
#           CI.level=0.95,
#           tail="above",
#           give.CI=TRUE,
#           Bmin=log(1),
#           Bmax=log(5),
#           # for type "line" and method "calibrated"
#           R=250,
#           dat = d,
#           yi.name = "yi",
#           vi.name = "vi")